<template>
  <div>
    <section aria-labelledby="information-heading " class="sm:pr-12">
      <h2 class="text-[2rem] text-bold-100">{{ goods?.name }}</h2>
      <p v-if="goods.price" class="text-[2rem] font-bold-100 font-bold mt-4">
        <!-- {{ getPriceRange(goods.price, goods.price_range.max_amount) }} -->
        ${{ goods.price }}
      </p>
      <p class="text-lg text-gray-500 mt-7">{{ goods?.introduction }}</p>
    </section>

    <section aria-labelledby="options-heading" class="mt-8">
      <template v-for="item in goods?.propertyVos" :key="item.propertyName">
        <div class="mt-7">
          <h4 class="text-lg text-blod-100">{{ item.propertyName }}Ôºö</h4>
          <fieldset class="mt-5">
            <span v-if="item.propertyName === 'Color'" class="flex items-center space-x-3">
              <button
                v-for="(spec_value, index) in item.valueNames"
                :key="`${index}-thumbnail`"
                type="button"
                :aria-current="spec_value.selected"
                :class="`w-[100px] h-[100px] mr-3 last:mr-0  relative shrink-0 border  rounded-[1.25rem]  snap-start cursor-pointer focus-visible:outline focus-visible:outline-offset transition-colors flex-grow md:flex-grow-0  ${
                  spec_value.selected ? 'border-primary-700' : 'border-transparent'
                }`"
                @click="clickSpecs(item, spec_value)"
              >
                <!-- :ref="(el) => assignRef(el, index)" -->
                <!-- @mouseover="clickSpecs(item, spec_value)"
                @focus="clickSpecs(item, spec_value)" -->
                <img class="rounded-[1.25rem]" width="150" height="150" :src="spec_value.picture || ''" />
              </button>
            </span>
            <div v-else class="grid grid-cols-2 gap-2 gap-x-[30px] gap-7-[15px] pr-[80px]">
              <label
                v-for="(spec_value, index) in item.valueNames"
                :key="`${index}-thumbnail`"
                :class="[
                  'relative flex items-center justify-center px-4 py-3 text-sm  border-gray-100 text-blod-100 uppercase bg-white border rounded-[100px] shadow-sm cursor-pointer group hover:border-primary-700 focus:outline-none sm:flex-1',
                  spec_value.selected ? 'border-primary-700 ' : '',
                  spec_value.disabled ? '!cursor-not-allowed !border-gray-200' : '',
                ]"
              >
                <input name="size-choice" :value="spec_value.name" class="sr-only" @click="clickSpecs(item, spec_value)" />
                <span>{{ spec_value.name }}</span>
                <span v-show="spec_value.disabled" class="absolute mx-4 pointer-events-none -inset-px">
                  <svg
                    class="absolute inset-0 w-full h-full text-gray-200 stroke-2"
                    viewBox="0 0 100 100"
                    preserveAspectRatio="none"
                    stroke="currentColor"
                  >
                    <line x1="0" y1="100" x2="100" y2="0" vector-effect="non-scaling-stroke" />
                  </svg>
                </span>
              </label>
            </div>
          </fieldset>
        </div>
      </template>

      <!-- Sizes -->
      <!-- Quantity -->
      <div class="mt-7">
        <div class="flex items-center justify-between">
          <h4 class="text-sm font-medium text-gray-900">QuantityÔºö</h4>
        </div>

        <fieldset class="mt-5">
          <div class="grid gap-4">
            <div class="flex">
              <input
                :id="inputId"
                v-model="count"
                type="number"
                class="flex-1 w-12 px-6 mr-2.5 text-lg py-4 text-gray-900 bg-transparent border rounded-100 appearance-none disabled:placeholder-disabled-900 [&::-webkit-inner-spin-button]:appearance-none [&::-webkit-inner-spin-button]:display-none [&::-webkit-inner-spin-button]:m-0 [&::-webkit-outer-spin-button]:display-none [&::-webkit-outer-spin-button]:m-0 [-moz-appearance:textfield] [&::-webkit-outer-spin-button]:appearance-none"
                :min="min"
                :max="max"
                @input="handleOnChange"
              />
              <SfButton
                square
                size="lg"
                class="!rounded-full mr-2.5"
                :disabled="count <= min"
                :aria-controls="inputId"
                aria-label="Decrease value"
                @click="dec()"
              >
                <SfIconRemove />
              </SfButton>
              <SfButton
                square
                size="lg"
                class="!rounded-full"
                :disabled="count >= max"
                :aria-controls="inputId"
                aria-label="Increase value"
                @click="inc()"
              >
                <SfIconAdd />
              </SfButton>
            </div>
          </div>
        </fieldset>
      </div>
      <button
        type="submit"
        class="flex items-center justify-center w-full py-[18px] text-lg text-white bg-primary-700 border border-transparent rounded-[100px] mt-7 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2"
      >
        Buy it now
      </button>

      <button
        type="submit"
        class="flex items-center justify-center w-full py-3 text-base text-white bg-black border border-transparent rounded-[100px] mt-7 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2"
        @click="addCart"
      >
        Add to bag
      </button>
      <div class="flex mt-10">
        <SfButton variant="tertiary" size="sm" square class="mr-6 !p-0 !text-bold-100 !bg-transparent" aria-label="Add to wishlist">
          <SfIconFavorite size="sm" />
          <!-- bg-white ring-1 ring-inset ring-neutral-200 !rounded-full -->
        </SfButton>
        <span class="text-lg text-blod-100">Add to wishlist</span>
      </div>
    </section>
  </div>
</template>

<script setup lang="ts">
defineOptions({ name: "ProductSpecs" });
import Message from "@/components/message/index";
import useStore from "@/stores";
import getPowerSet from "./power-set";
import { ref } from "vue";

import { useCounter } from "@vueuse/core";
import { SfButton, SfIconAdd, SfIconRemove, useId, SfIconFavorite } from "@storefront-ui/vue";
import type { PropType } from "vue";
import type { SKU, ShopGoods, PropertyVo, PropertyValue } from "@/types/shop";
import type { CartItem } from "@/types";
// import { getPriceRange } from "@/utils/index";
import { clamp } from "@storefront-ui/shared";
// const router = useRouter();
import { useRoute } from "vue-router";
// ‰ªéË∑ØÁî±‰∏≠Ëé∑ÂèñÂïÜÂìÅ id
const { params } = useRoute();
const min = ref(1);
const max = ref(10);
const inputId = useId();
const { count, inc, dec, set } = useCounter(1, {
  min: min.value,
  max: max.value,
});
function handleOnChange(event: Event) {
  const currentValue = (event.target as HTMLInputElement)?.value;
  const nextValue = parseFloat(currentValue);
  set(clamp(nextValue, min.value, max.value));
  emit("add", count.value);
}
// const firstThumbRef = ref<HTMLButtonElement>();
// const lastThumbRef = ref<HTMLButtonElement>();

// const assignRef = (el: Element | ComponentPublicInstance | null, index: number) => {
//   if (!el) return;
//   if (index === images.length - 1) {
//     lastThumbRef.value = el as HTMLButtonElement;
//   } else if (index === 0) {
//     firstThumbRef.value = el as HTMLButtonElement;
//   }
// };
export interface SkuEmit {
  skuId: string;
  price: string;
  // oldPrice: string;
  count: number;
  inventory: number;
  specsText: string;
}

type PathMap = { [key: string]: string[] };

const spliter = "‚òÖ";
// // Ê†πÊçÆskusÊï∞ÊçÆÂæóÂà∞Ë∑ØÂæÑÂ≠óÂÖ∏ÂØπË±°
const getPathMap = (skus: SKU[]) => {
  // debugger;
  console.log("getPathMap", skus);

  const pathMap = {} as PathMap;
  skus.forEach((sku: SKU) => {
    // console.log(2323);

    // 1. ËøáÊª§Âá∫ÊúâÂ∫ìÂ≠òÊúâÊïàÁöÑsku

    if (!sku.stock) return;
    // 2. ÂæóÂà∞skuÂ±ûÊÄßÂÄºÊï∞ÁªÑ
    const specs = sku.properties.map((spec) => spec.valueName);
    // 3. ÂæóÂà∞skuÂ±ûÊÄßÂÄºÊï∞ÁªÑÁöÑÂ≠êÈõÜ
    const powerSet = getPowerSet(specs);
    console.log("powerSet", powerSet);

    // 4. ËÆæÁΩÆÁªôË∑ØÂæÑÂ≠óÂÖ∏ÂØπË±°
    powerSet.forEach((set) => {
      const key = set.join(spliter);
      // Â¶ÇÊûúÊ≤°ÊúâÂ∞±ÂÖàÂàùÂßãÂåñ‰∏Ä‰∏™Á©∫Êï∞ÁªÑ
      if (!pathMap[key]) {
        pathMap[key] = [];
      }
      pathMap[key].push(String(sku.id));
    });

    console.log("pathMap", JSON.parse(JSON.stringify(pathMap)));
  });
  console.log("üîîÊ†πÊçÆÂêéÁ´ØËøîÂõûÁöÑskusÈõÜÂêàÂæóÂà∞Áî®‰∫éÊü•ËØ¢Ë∑ØÂæÑÂ≠óÂÖ∏", pathMap);
  return pathMap;
};

// // ÂàùÂßãÂåñÁ¶ÅÁî®Áä∂ÊÄÅ
function initDisabledStatus(specs: PropertyVo[], pathMap: PathMap) {
  specs.forEach((spec: PropertyVo) => {
    spec.valueNames.forEach((val: PropertyValue) => {
      // ËÆæÁΩÆÁ¶ÅÁî®Áä∂ÊÄÅ
      val.disabled = !pathMap[val.name];
    });
  });
}

// // ÂæóÂà∞ÂΩìÂâçÈÄâ‰∏≠ËßÑÊ†ºÈõÜÂêà
const getSelectedArr = (specs: PropertyVo[]) => {
  const selectedArr: (string | undefined)[] = [];
  specs.forEach((spec, index) => {
    const selectedVal = spec.valueNames.find((val) => val.selected);
    if (selectedVal) {
      selectedArr[index] = selectedVal.name;
    } else {
      selectedArr[index] = undefined;
    }
  });
  return selectedArr;
};

// Êõ¥Êñ∞ÊåâÈíÆÁöÑÁ¶ÅÁî®Áä∂ÊÄÅ
// Êõ¥Êñ∞Á¶ÅÁî®Áä∂ÊÄÅÊ†∏ÂøÉÔºöËé∑ÂèñÂΩìÂâçÁî®Êà∑ÈÄâ‰∏≠ÁöÑËßÑÊ†ºÔºåÂÜçÊ®°ÊãüÁî®Êà∑‰∏ã‰∏ÄÊ¨°ÁöÑËßÑÊ†ºÈÄâÊã©ÔºåÂéªÂ≠óÂÖ∏‰∏≠Êü•ËØ¢ÔºåÊü•ËØ¢‰∏çÂà∞ËÆæÁΩÆ‰∏∫Á¶ÅÁî®Áä∂ÊÄÅ
const updateDisabledStatus = (specs: PropertyVo[], pathMap: PathMap) => {
  // ÈÅçÂéÜÊØè‰∏ÄÁßçËßÑÊ†º
  specs.forEach((item, i) => {
    // ÊãøÂà∞ÂΩìÂâçÈÄâÊã©ÁöÑÈ°πÁõÆ
    const selectedArr = getSelectedArr(specs);
    // ÈÅçÂéÜÊØè‰∏Ä‰∏™ÊåâÈíÆ
    item.valueNames.forEach((val) => {
      if (!val.selected) {
        selectedArr[i] = val.name;
        // ÂéªÊéâundefined‰πãÂêéÁªÑÂêàÊàêkey
        const key = selectedArr.filter((value) => value).join(spliter);
        val.disabled = !pathMap[key];
      }
    });
  });
};

// // ÂàùÂßãÂåñÈÄâ‰∏≠Áä∂ÊÄÅ
const initSelectedStatus = (goods: ShopGoods, skuId: string) => {
  // ÊâæÂà∞ÂΩìÂâçÁöÑskuÂØπË±°
  const sku = goods.skus.find((sku) => String(sku.id) === skuId);

  if (sku) {
    goods.propertyVos.forEach((item: PropertyVo, i) => {
      const val = item.valueNames.find((val: PropertyValue) => val.name === sku.properties[i].valueName);
      if (val) val.selected = true;
    });
  }
};

// // ‰ΩøÁî®ÁªÑ‰ª∂ <XtxGoodSku :goods="xxx" :skuId="xxx"  @change="xxx"  />
const props = defineProps({
  // specs:ÊâÄÊúâÁöÑËßÑÊ†º‰ø°ÊÅØ  skus:ÊâÄÊúâÁöÑskuÁªÑÂêà
  goods: {
    type: Object as PropType<ShopGoods>,
    default: () => ({ propertyVos: [], skus: [] }),
  },
  skuId: String,
});

interface Emit {
  (e: "change", value: SkuEmit): void;
}
// const skuId = params.id;
const emit = defineEmits<Emit>();

// ÂæóÂà∞ÊâÄÊúâÂ≠óÂÖ∏ÈõÜÂêà

const pathMap = getPathMap(props.goods.skus);
// // ÁªÑ‰ª∂ÂàùÂßãÂåñÁöÑÊó∂ÂÄôÊõ¥Êñ∞Á¶ÅÁî®Áä∂ÊÄÅ
initDisabledStatus(props.goods.propertyVos, pathMap);
console.log("props.skuId", props.skuId);

const cartItem = ref<CartItem>();
// // Ê†πÊçÆ‰º†ÂÖ•ÁöÑskuIdÈªòËÆ§ÈÄâ‰∏≠ËßÑÊ†ºÊåâÈíÆ
if (props.skuId) {
  initSelectedStatus(props.goods, String(props.skuId));
  if (cartItem.value) cartItem.value.skuId = props.skuId;
}
// Áî®Êà∑ÁÇπÂáªÈÄâÊã©ËßÑÊ†º - Ê®°Êãü‰∏ãÊ¨°ÁÇπÂáª
const clickSpecs = (item: PropertyVo, val: PropertyValue) => {
  if (val.disabled) return false;
  // ÈÄâ‰∏≠‰∏éÂèñÊ∂àÈÄâ‰∏≠ÈÄªËæë
  if (val.selected) {
    val.selected = false;
  } else {
    item.valueNames.forEach((bv) => {
      bv.selected = false;
    });
    val.selected = true;
  }
  console.log("val.selected", val.selected);
  // üîî ÁÇπÂáª‰πãÂêéÂÜçÊ¨°Êõ¥Êñ∞ÈÄâ‰∏≠Áä∂ÊÄÅ
  updateDisabledStatus(props.goods.propertyVos, pathMap);
  // ÊääÈÄâÊã©ÁöÑsku‰ø°ÊÅØ‰º†Âá∫ÂéªÁªôÁà∂ÁªÑ‰ª∂
  // Ëß¶Âèëchange‰∫ã‰ª∂Â∞ÜskuÊï∞ÊçÆ‰º†ÈÄíÂá∫Âéª
  const selectedArr = getSelectedArr(props.goods.propertyVos).filter((value) => value);
  // Â¶ÇÊûúÈÄâ‰∏≠ÂæóËßÑÊ†ºÊï∞ÈáèÂíå‰º†ÂÖ•ÂæóËßÑÊ†ºÊÄªÊï∞Áõ∏Á≠âÂàô‰º†Âá∫ÂÆåÊï¥‰ø°ÊÅØ(ÈÉΩÈÄâÊã©‰∫Ü)
  // Âê¶Âàô‰º†Âá∫Á©∫ÂØπË±°
  if (selectedArr.length === props.goods.propertyVos.length) {
    // ‰ªéË∑ØÂæÑÂ≠óÂÖ∏‰∏≠ÂæóÂà∞skuId
    const skuId = pathMap[selectedArr.join(spliter)][0];
    const sku = props.goods.skus.find((sku) => String(sku.id) === skuId) as SKU;
    console.log("sku", sku, count.value);

    cartItem.value = {
      id: String(props.goods.id),
      name: props.goods.name,
      isEffective: true,
      picture: sku.picUrl || props.goods.picUrl,
      skuId: String(sku.id),
      price: sku.price,
      stock: sku.stock,
      count: count.value,
      attrsText: sku.properties.reduce((p: any, n: any) => `${p} ${n.propertyName}Ôºö${n.valueName}`, "").trim(),
    };
  }
};

const { cart } = useStore();

// Âä†ÂÖ•Ë¥≠Áâ©ÊåâÈíÆÁÇπÂáª
const addCart = () => {
  // Ê≤°Êúâ skuIdÔºåÊèêÈÜíÁî®Êà∑Âπ∂ÈÄÄÂá∫ÂáΩÊï∞
  if (!cartItem.value?.skuId) {
    Message.text("ËØ∑ÈÄâÊã©ÂÆåÊï¥ÂïÜÂìÅËßÑÂàô");
    return;
    // return message({ type: "warn", text: "ËØ∑ÈÄâÊã©ÂÆåÊï¥ÂïÜÂìÅËßÑÂàô~" });
  }
  if (!count.value) {
    Message.text("ËØ∑ËæìÂÖ•ÂïÜÂìÅÊï∞Èáè");
    return;
  }
  cartItem.value.count = count.value;

  console.log("üò≠ cartItem Êï∞ÊçÆÁªà‰∫éÂáÜÂ§áÂÆåÊØï‰∫Ü", cartItem);
  // Ë∞ÉÁî®Âä†ÂÖ•Ë¥≠Áâ©ËΩ¶Êé•Âè£
  cart.addCart(cartItem.value);
};
</script>
